<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code</title>
    <script>
        function generateUniqueID() {
            return 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Ajustar las URLs de las funciones según la estructura de tu proyecto
            const endpointCheckDevice = 'https://promo-qr.netlify.app/.netlify/functions/backend/api/check-device'; // URL para verificar el dispositivo
            const endpointMarkScanned = 'https://promo-qr.netlify.app/.netlify/functions/backend/api/mark-scanned'; // URL para marcar como escaneado
            let deviceID = localStorage.getItem('deviceID');

            if (!deviceID) {
                deviceID = generateUniqueID();
                localStorage.setItem('deviceID', deviceID);
                console.log(`Nuevo dispositivo generado: ${deviceID}`);

                // Registrar dispositivo por primera vez
                fetch(endpointCheckDevice, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceID }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta al registrar dispositivo:', data);
                    if (data.firstTime) {
                        window.location.href = 'https://promo-qr.netlify.app/nueva'; // URL para usuarios nuevos
                    } else {
                        window.location.href = 'https://promo-qr.netlify.app/ya-escaneado'; // URL para usuarios que ya escanearon
                    }
                })
                .catch(error => {
                    console.error('Error al registrar el dispositivo:', error);
                });
            } else {
                console.log(`Dispositivo existente: ${deviceID}`);

                // Verificar si el dispositivo ya escaneó
                fetch(endpointCheckDevice, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceID }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta al verificar dispositivo:', data);
                    if (!data.firstTime) {
                        // Si ya fue escaneado, redirige a la URL correspondiente
                        window.location.href = 'https://promo-qr.netlify.app/ya-escaneado'; // URL para usuarios que ya escanearon
                    } else {
                        // Si no ha sido escaneado, márcalo como escaneado
                        fetch(endpointMarkScanned, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ deviceID }),
                        })
                        .then(() => {
                            window.location.href = 'https://promo-qr.netlify.app/nueva'; // URL para usuarios nuevos
                        })
                        .catch(error => {
                            console.error('Error al marcar como escaneado:', error);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al verificar el dispositivo:', error);
                });
            }
        });
    </script>
</head>
<body>
    <h1>Escaneaste el código QR</h1>
</body>
</html>
